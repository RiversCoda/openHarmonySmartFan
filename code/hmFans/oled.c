#include "oled.h"
#include "stdlib.h"
#include "string.h" 	 
#include "base_type.h" 
//#include "delay.h"
//#include "spi.h"
//OLED�Դ��ܹ���Ϊ8ҳ
//ÿҳ8�У�һ��128�����ص�
//OLED���Դ�
//��Ÿ�ʽ����.
//[0]0 1 2 3 ... 127 (0~7)��	   
//[1]0 1 2 3 ... 127 (8~15)��	
//[2]0 1 2 3 ... 127 (16~23)��	
//[3]0 1 2 3 ... 127 (24~31)��	
//[4]0 1 2 3 ... 127 (32~39)��	
//[5]0 1 2 3 ... 127 (40~47)��	
//[6]0 1 2 3 ... 127 (48~55)��	
//[7]0 1 2 3 ... 127 (56~63)��			   

//����ÿ��bit�洢OLEDÿ�����ص����ɫֵ(1-��(��ɫ),0-��(��ɫ))
//ÿ������Ԫ�ر�ʾ1��8�����ص㣬һ��128��
static unsigned char OLED_buffer[1024] = 
{
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfd, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfd, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x3f, 0xfc, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x1f, 0xfe, 0x1f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8f, 0xe0, 0x00, 0x1f, 0x7e, 0x1f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xb7, 0xe0, 0x00, 0x16, 0x1e, 0x1f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf7, 0xd0, 0x00, 0x03, 0x1e, 0x07, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf7, 0xe0, 0x00, 0x00, 0x3e, 0x0f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x01, 0x0e, 0x0f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc1, 0x00, 0x00, 0x07, 0x27, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x03, 0x83, 0xf7, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0xf0, 0x00, 0x87, 0xf7, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x7e, 0x01, 0x87, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x01, 0xe0, 0x73, 0x01, 0x86, 0x70, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x02, 0x20, 0x51, 0xc1, 0xfe, 0x20, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x7f, 0xc2, 0xf9, 0xd8, 0x0b, 0xc3, 0xc0, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0x08, 0x1f, 0xff, 0xff, 0xe8, 0x03, 0xc7, 0xc0, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0xc8, 0x5f, 0xff, 0xff, 0xe4, 0x17, 0xef, 0x00, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x07, 0xf7, 0xff, 0xff, 0x7f, 0xf6, 0x0f, 0xf8, 0x00, 0x7f, 
    0x00, 0x00, 0x00, 0x00, 0x0d, 0xf7, 0xff, 0x07, 0xef, 0xff, 0x0f, 0xfe, 0x21, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x1e, 0xff, 0xff, 0xc7, 0xf8, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfd, 0xfc, 0x7f, 0x9f, 0x9f, 0x38, 0x07, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x7f, 0x1f, 0x3f, 0x18, 0x03, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x42, 0x33, 0xff, 0xf8, 0x7e, 0x1e, 0x3f, 0x09, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xfc, 0x10, 0x7e, 0x7c, 0x7e, 0x0c, 0x07, 0x01, 0x85, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xf8, 0x0c, 0x0c, 0x00, 0xfe, 0x0c, 0x1f, 0xc3, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x01, 0xfe, 0x0e, 0x0f, 0xe7, 0x09, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x07, 0xfe, 0x0f, 0xaf, 0x97, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x0f, 0xfe, 0x0f, 0xbf, 0xf8, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x3b, 0xf0, 0x00, 0x3f, 0xff, 0x0f, 0xff, 0xfc, 0x0f, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x33, 0xcf, 0x9f, 0xff, 0xff, 0x1f, 0xef, 0xf8, 0x0f, 0xdf, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x7f, 0xc7, 0xff, 0x3f, 0x2c, 0xf6, 0x07, 0x3f, 
    0x00, 0x00, 0x00, 0x00, 0x7f, 0xe7, 0xff, 0x83, 0xff, 0xfe, 0x28, 0xe6, 0x03, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xff, 0xfe, 0x7f, 0x01, 0xff, 0xfa, 0x28, 0xf2, 0x01, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0xff, 0xe0, 0x0e, 0x01, 0xff, 0xf8, 0x08, 0xd6, 0x04, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x00, 0x3f, 0xfd, 0x2f, 0xf7, 0xce, 0x1f, 
    0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x1f, 0xff, 0x1b, 0xff, 0xef, 0x0f, 
    0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x10, 0x00, 0x07, 0x07, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x70, 0x00, 0x07, 0xcf, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xbe, 0x1f, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x3f, 0xff, 0x3f, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2b, 0xe0, 0x3f, 0xfc, 0x7f, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf8, 0x3f, 0xfe, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xfe, 0x3f, 0xdd, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0x03, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xee, 0x07, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x03, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc3, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xe3, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xf9, 0xff, 0xff, 0xff, 0x1f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xef, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x87, 
    0x00, 0x00, 0x00, 0x00, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 
    0x00, 0x00, 0x00, 0x00, 0x3b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0x1f,
};

/*******************************************************************
 * @name       :void OLED_WR_Byte(unsigned dat,unsigned cmd)
 * @date       :2018-08-27
 * @function   :Write a byte of content to the OLED screen
 * @parameters :dat:Content to be written
                cmd:0-write command
								    1-write data
 * @retvalue   :None
********************************************************************/
void OLED_WR_Byte(unsigned dat,unsigned cmd)
{
	if(cmd)
	{
		OLED_DC_Set();
	}
	else
	{
		OLED_DC_Clr();
	}
	OLED_CS_Clr();
	SPI_WriteByte(SPI2,dat);
	OLED_CS_Set();
}

/*******************************************************************
 * @name       :void OLED_Set_Pos(unsigned char x, unsigned char y) 
 * @date       :2018-08-27
 * @function   :Set coordinates in the OLED screen
 * @parameters :x:x coordinates
                y:y coordinates
 * @retvalue   :None
********************************************************************/
void OLED_Set_Pos(unsigned char x, unsigned char y) 
{
 	OLED_WR_Byte(YLevel+y/PAGE_SIZE,OLED_CMD);
	OLED_WR_Byte((((x+2)&0xf0)>>4)|0x10,OLED_CMD);
	OLED_WR_Byte(((x+2)&0x0f),OLED_CMD); 
}  

/*******************************************************************
 * @name       :void OLED_Display_On(void) 
 * @date       :2018-08-27
 * @function   :Turn on OLED display
 * @parameters :None
 * @retvalue   :None
********************************************************************/ 	  
void OLED_Display_On(void)
{
	OLED_WR_Byte(0X8D,OLED_CMD);  //SET DCDC����
	OLED_WR_Byte(0X14,OLED_CMD);  //DCDC ON
	OLED_WR_Byte(0XAF,OLED_CMD);  //DISPLAY ON
}

/*******************************************************************
 * @name       :void OLED_Display_Off(void)
 * @date       :2018-08-27
 * @function   :Turn off OLED display
 * @parameters :None
 * @retvalue   :None
********************************************************************/    
void OLED_Display_Off(void)
{
	OLED_WR_Byte(0X8D,OLED_CMD);  //SET DCDC����
	OLED_WR_Byte(0X10,OLED_CMD);  //DCDC OFF
	OLED_WR_Byte(0XAE,OLED_CMD);  //DISPLAY OFF
}

/*******************************************************************
 * @name       :void OLED_Set_Pixel(unsigned char x, unsigned char y,unsigned char color)
 * @date       :2018-08-27
 * @function   :set the value of pixel to RAM
 * @parameters :x:the x coordinates of pixel
                y:the y coordinates of pixel
								color:the color value of the point
								      1-white
											0-black
 * @retvalue   :None
********************************************************************/ 
void OLED_Set_Pixel(unsigned char x, unsigned char y,unsigned char color)
{
	if(color)
	{
		OLED_buffer[(y/PAGE_SIZE)*WIDTH+x]|= (1<<(y%PAGE_SIZE))&0xff;
	}
	else
	{
		OLED_buffer[(y/PAGE_SIZE)*WIDTH+x]&= ~((1<<(y%PAGE_SIZE))&0xff);
	}
}		   			 

/*******************************************************************
 * @name       :void OLED_Display(void)
 * @date       :2018-08-27
 * @function   :Display in OLED screen
 * @parameters :None
 * @retvalue   :None
********************************************************************/  
void OLED_Display(void)
{
	u8 i,n;		    
	for(i=0;i<PAGE_SIZE;i++)  
	{  
		OLED_WR_Byte (YLevel+i,OLED_CMD);    //����ҳ��ַ��0~7��
		OLED_WR_Byte (XLevelL,OLED_CMD);      //������ʾλ�á��е͵�ַ
		OLED_WR_Byte (XLevelH,OLED_CMD);      //������ʾλ�á��иߵ�ַ   
		for(n=0;n<WIDTH;n++)
		{
			OLED_WR_Byte(OLED_buffer[i*WIDTH+n],OLED_DATA); 
		}
	}   //������ʾ
}

/*******************************************************************
 * @name       :void OLED_Clear(unsigned dat)  
 * @date       :2018-08-27
 * @function   :clear OLED screen
 * @parameters :dat:0-Display full black
                    1-Display full white
 * @retvalue   :None
********************************************************************/ 
void OLED_Clear(unsigned dat)  
{  
	if(dat)
	{
		memset(OLED_buffer,0xff,sizeof(OLED_buffer));
	}
	else
	{
		memset(OLED_buffer,0,sizeof(OLED_buffer));
	}
	OLED_Display();
}

/*******************************************************************
 * @name       :void OLED_Reset(void) 
 * @date       :2018-08-27
 * @function   :Reset OLED screen
 * @parameters :dat:0-Display full black
                    1-Display full white
 * @retvalue   :None
********************************************************************/ 
void OLED_Reset(void)
{
	OLED_RST_Set();
	delay_ms(100);
	OLED_RST_Clr();
	delay_ms(100);
	OLED_RST_Set(); 
}	
	
/*******************************************************************
 * @name       :void OLED_Init_GPIO(void)
 * @date       :2018-08-27
 * @function   :Reset OLED screen
 * @parameters :None
 * @retvalue   :None
********************************************************************/ 
void OLED_Init_GPIO(void)
{
/*
	GPIO_InitTypeDef  GPIO_InitStructure;
 	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);	 //ʹ��B�˿�ʱ��
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10|GPIO_Pin_11|GPIO_Pin_12;	//GPIOB10,11,12 
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; 		 //�������
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;//�ٶ�50MHz
 	GPIO_Init(GPIOB, &GPIO_InitStructure);	  //��ʼ��GPIOB10��11��12
 	GPIO_SetBits(GPIOB,GPIO_Pin_10|GPIO_Pin_11|GPIO_Pin_12);	
*/
    return;
}

/*******************************************************************
 * @name       :void OLED_Init(void)
 * @date       :2018-08-27
 * @function   :initialise OLED SH1106 control IC
 * @parameters :None
 * @retvalue   :None
********************************************************************/ 				    
void OLED_Init(void)
{
 	//OLED_Init_GPIO(); //��ʼ��GPIO
    //printf("%s,%s,%d \r\n",__FILE__,__func__,__LINE__);
 	delay_ms(200); 
	OLED_Reset();     //��λOLED
    printf("%s,%s,%d \r\n",__FILE__,__func__,__LINE__);

/**************��ʼ��SSD1306*****************/	
	OLED_WR_Byte(0xAE,OLED_CMD); /*display off*/
	OLED_WR_Byte(0x00,OLED_CMD); /*set lower column address*/
	OLED_WR_Byte(0x10,OLED_CMD); /*set higher column address*/
	OLED_WR_Byte(0x40,OLED_CMD); /*set display start line*/ 
	OLED_WR_Byte(0xB0,OLED_CMD); /*set page address*/
	OLED_WR_Byte(0x81,OLED_CMD); /*contract control*/ 
	OLED_WR_Byte(0xFF,OLED_CMD); /*128*/
	OLED_WR_Byte(0xA1,OLED_CMD); /*set segment remap*/ 
	OLED_WR_Byte(0xA6,OLED_CMD); /*normal / reverse*/
	OLED_WR_Byte(0xA8,OLED_CMD); /*multiplex ratio*/ 
	OLED_WR_Byte(0x3F,OLED_CMD); /*duty = 1/64*/
	OLED_WR_Byte(0xC8,OLED_CMD); /*Com scan direction*/
	OLED_WR_Byte(0xD3,OLED_CMD); /*set display offset*/ 
	OLED_WR_Byte(0x00,OLED_CMD);
	OLED_WR_Byte(0xD5,OLED_CMD); /*set osc division*/ 
	OLED_WR_Byte(0x80,OLED_CMD);
	OLED_WR_Byte(0xD9,OLED_CMD); /*set pre-charge period*/ 
	OLED_WR_Byte(0XF1,OLED_CMD);
	OLED_WR_Byte(0xDA,OLED_CMD); /*set COM pins*/ 
	OLED_WR_Byte(0x12,OLED_CMD);
	OLED_WR_Byte(0xDB,OLED_CMD); /*set vcomh*/ 
	OLED_WR_Byte(0x30,OLED_CMD);
	OLED_WR_Byte(0x8D,OLED_CMD); /*set charge pump disable*/ 
	OLED_WR_Byte(0x14,OLED_CMD);
	OLED_WR_Byte(0xAF,OLED_CMD); /*display ON*/
    
    printf("%s,%s,%d \r\n",__FILE__,__func__,__LINE__);
}  

